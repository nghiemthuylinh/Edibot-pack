<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <title>Edison CPD Chatbot</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    body{font-family:Candara;background:#fff;margin:0;display:flex;flex-direction:column;height:100vh}
    header{padding:10px;background:#f05a23;color:#fff;text-align:center;font-weight:bold}
    #chat{flex:1;overflow:auto;padding:10px;position:relative}
    /* Logo n·ªÅn: ~80% m·ªù (opacity .2) */
    #chat::before{
      content:"";position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
      background:url('/avatars/logo-edison.png') no-repeat center center;
      background-size:50% auto;opacity:.2;width:100%;height:100%;pointer-events:none
    }
    .row{display:flex;margin:8px 0;animation:fade .25s ease-out}
    @keyframes fade{from{opacity:.2;transform:translateY(4px)}to{opacity:1;transform:none}}
    .row.user{justify-content:flex-end}
    .bubble{padding:10px;border-radius:10px;max-width:70%;white-space:pre-wrap; line-height:1.4}
    .row.user .bubble{background:#ffe5d5}
    .row.bot .bubble{background:#f1f1f1}
    .avatar{width:32px;height:32px;border-radius:50%;margin:0 6px}
    .muted{opacity:.75;font-style:italic}

    .suggestions{display:flex;flex-wrap:wrap;gap:8px;padding:8px 10px;border-top:1px solid #eee}
    .suggestions button{border:1px solid #ddd;background:#fff;border-radius:999px;padding:6px 10px;cursor:pointer}
    .suggestions button:hover{border-color:#f05a23}

    .privacy{font-size:12px;color:#666;text-align:center;padding:5px;display:none}
    footer{display:flex;padding:10px;border-top:1px solid #ddd;gap:8px}
    footer input{flex:1;padding:10px;border:1px solid #ccc;border-radius:5px}
    footer button{padding:10px 12px;background:#f05a23;color:#fff;border:none;border-radius:5px;cursor:pointer}
    footer button[disabled]{opacity:.6;cursor:not-allowed}
  </style>
</head>
<body>
  <header>Edison CPD Chatbot</header>

  <div id="chat"></div>
  <div id="sugg" class="suggestions"></div>

  <div class="privacy" id="privacy">Your chat may be saved to a private log for quality and troubleshooting.</div>

  <footer>
    <input id="inp" placeholder="Type your message..." autocomplete="off"/>
    <button id="btn" type="button" title="Send (Enter)">Send</button>
    <button id="reset" type="button" title="Start new session">Start new session</button>
  </footer>

<script>
const ENDPOINT = "/.netlify/functions/assist1";
const LOG_ENDPOINT = "/.netlify/functions/drive-log";
// ASSISTANT_ID kh√¥ng c·∫ßn ·ªü client (server ƒë√£ c√≥), gi·ªØ l·∫°i n·∫øu b·∫°n d√πng log
const ASSISTANT_ID = "asst_xxxxxxxxxxxxxxxxxxxxx";

const $chat=document.getElementById('chat');
const $inp=document.getElementById('inp');
const $btn=document.getElementById('btn');
const $reset=document.getElementById('reset');
const $privacy=document.getElementById('privacy');
const $sugg=document.getElementById('sugg');

const SUGGESTIONS=[
  "What is SEL?",
  "Observation procedure?",
  "What is Bloom's Taxonomy?",
  "How to write backward design objectives?",
  "What is my level in teaching English?"
];

function addBubble(role,text,extraClass=""){
  const row=document.createElement('div');row.className="row "+role;
  const avatar=document.createElement('img');avatar.className="avatar";avatar.alt=role;avatar.src=role==="user"?"/avatars/user.png":"/avatars/bot.png";
  const bubble=document.createElement('div');bubble.className="bubble "+extraClass;bubble.textContent=text;
  if(role==="user"){row.appendChild(bubble);row.appendChild(avatar);} else {row.appendChild(avatar);row.appendChild(bubble);}
  $chat.appendChild(row);$chat.scrollTop=$chat.scrollHeight;
  return bubble;
}
function renderSuggestions(){
  $sugg.innerHTML="";
  SUGGESTIONS.forEach(q=>{
    const b=document.createElement('button'); b.type="button"; b.textContent=q;
    b.onclick=()=>{ $inp.value=q; send(); };
    $sugg.appendChild(b);
  });
}

function getEmail(){
  const m=document.cookie.split('; ').find(r=>r.startsWith('edison_email='));
  return m?decodeURIComponent(m.split('=')[1]):null;
}
function setEmail(email){
  document.cookie="edison_email="+encodeURIComponent(email)+"; max-age="+60*60*24*90+"; path=/";
}
function getSession(){
  if(!sessionStorage.session_id) sessionStorage.session_id="s_"+Date.now()+"_"+Math.random().toString(36).slice(2);
  return sessionStorage.session_id;
}
function getThread(){return localStorage.getItem("thread_id")||"";}
function setThread(id){localStorage.setItem("thread_id",id);}

function fmtReply(text){
  return (text || "")
    .split(/\r?\n/).map(s => s.trim()).filter(Boolean)
    .map(l => l.startsWith("üëâ") ? l : "üëâ " + l)
    .join("\n");
}
function cleanAssistant(text){
  if (!text) return "";
  let t = text;
  const cutMarks = [
    /^#+\s*references\b/i, /^#+\s*resources\b/i,
    /^#+\s*(t√†i li·ªáu|tham kh·∫£o)\b/i,
    /^\s*(references|resources|t√†i li·ªáu tham kh·∫£o|ngu·ªìn)\s*:\s*$/i
  ];
  const lines = t.split(/\r?\n/);
  const idx = lines.findIndex(line => cutMarks.some(rx => rx.test(line.trim())));
  if (idx !== -1) t = lines.slice(0, idx).join("\n");
  t = t.replace(/\[[^\]]*source[^\]]*\]/gi, ""); // [..source..]
  t = t.replace(/\[\s*\d+\s*\]/g, "");          // [1], [2]...
  t = t.replace(/\n{2,}/g, "\n");
  t = t.replace(/\b(as an ai|i'm an ai|as a language model)[^.\n]*[.\n]/gi, "");
  return t.trim();
}

function animateThinking(bubble){
  let dots=0;
  bubble.textContent="ƒêang x·ª≠ l√Ω";
  const t = setInterval(()=>{ dots=(dots+1)%4; bubble.textContent = "ƒêang x·ª≠ l√Ω" + ".".repeat(dots); },400);
  return ()=>clearInterval(t);
}

async function callAssist(payload){
  const res = await fetch(ENDPOINT, { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(payload) });
  const text = await res.text();
  let data = {};
  try{ data = text? JSON.parse(text) : {}; }catch{ data = { error: "Bad JSON", raw:text }; }
  return { status: res.status, ok: res.ok, data, text, headers: res.headers };
}

async function pollUntilDone(threadId, runId, thinkingBubble){
  const stop = animateThinking(thinkingBubble);
  for (let i=0;i<60;i++){ // ~24s
    const r = await callAssist({ action:"poll", threadId, runId });
    if (r.status === 200 && r.data && r.data.done) { stop(); return r.data.reply || "No response."; }
    if (r.status !== 202) break;
    await new Promise(res=>setTimeout(res, 400));
  }
  stop();
  return "H·ªá th·ªëng ƒëang b·∫≠n. Vui l√≤ng th·ª≠ l·∫°i.";
}

async function streamFirstThenFallback({msg,email,thinking}){
  // 1) th·ª≠ stream qua fetch + ReadableStream
  try{
    const res = await fetch(ENDPOINT, {
      method: "POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify({ action: "stream", message: msg, email, session: getSession(), threadId: getThread() })
    });

    const ct = res.headers.get("content-type") || "";
    if (res.ok && ct.startsWith("text/event-stream") && res.body) {
      const reader = res.body.getReader();
      const decoder = new TextDecoder();
      let acc = ""; // t√≠ch l≈©y text
      let threadIdFromMeta = "";

      const stop = animateThinking(thinking);

      while (true) {
        const { done, value } = await reader.read();
        if (done) break;
        const chunk = decoder.decode(value, { stream: true });

        // SSE lines: either "event: ..." or "data: ...\n\n"
        const lines = chunk.split(/\r?\n/);
        for (const line of lines) {
          if (!line) continue;
          if (line.startsWith("event:")) {
            // ignore or handle event name
            continue;
          }
          if (line.startsWith("data:")) {
            const raw = line.slice(5).trim();
            if (!raw) continue;
            try {
              const obj = JSON.parse(raw);
              if (obj.threadId) {
                threadIdFromMeta = obj.threadId;
                setThread(threadIdFromMeta);
              } else if (obj.type === "delta" && typeof obj.text === "string") {
                acc += obj.text;
                thinking.classList.remove("muted");
                thinking.textContent = cleanAssistant(acc);
                $chat.scrollTop = $chat.scrollHeight;
              }
            } catch{ /* ignore parse errors */ }
          }
        }
      }
      stop();

      // n·∫øu acc c√≥ d·ªØ li·ªáu ‚Üí th√†nh c√¥ng, kh√¥ng fallback
      if (acc.trim()) return true;
      // n·∫øu kh√¥ng c√≥ d·ªØ li·ªáu, s·∫Ω fallback
    }
  } catch(e){
    // ignore ‚Üí fallback
  }
  return false;
}

let sending = false;
async function send(){
  if (sending) return;
  let email=getEmail();
  if(!email){
    const input=prompt("What is your email in Edison Schools?");
    if(!input||!/@edisonschools\.edu\.vn$/i.test(input)){alert("Email must be @edisonschools.edu.vn");return;}
    setEmail(input); email=input;
  }
  const msg=$inp.value.trim(); if(!msg) return;
  $inp.value=""; $inp.focus();

  addBubble("user", msg);
  const thinking=addBubble("bot","...", "muted");
  $btn.disabled=true; $inp.disabled=true; sending=true;

  try{
    // Try STREAM first (Assistants v2 runs.stream)
    const streamed = await streamFirstThenFallback({ msg, email, thinking });

    if (!streamed) {
      // Fallback: nh·ªãp c≈© (ask ‚Üí 200/202 ‚Üí poll)
      const ask = await callAssist({ message: msg, email, session: getSession(), threadId: getThread() });

      if (!ask.ok && ask.status !== 202) {
        thinking.textContent = `‚ö†Ô∏è Server ${ask.status}: ${ask.text || 'No body'}`;
        return;
      }

      let reply = "";
      let realThreadId = ask.data?.threadId || getThread();
      if (ask.status === 200 && ask.data?.reply) {
        reply = ask.data.reply;
        if (ask.data.threadId) setThread(ask.data.threadId);
      } else {
        realThreadId = ask.data?.threadId || realThreadId;
        if (realThreadId) setThread(realThreadId);
        const runId = ask.data?.runId;
        reply = await pollUntilDone(realThreadId, runId, thinking);
      }

      thinking.classList.remove("muted");
      thinking.textContent = fmtReply(cleanAssistant(reply));
    }

    // Best-effort log (kh√¥ng ch·∫∑n UI)
    try {
      fetch(LOG_ENDPOINT, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({
          session: getSession(),
          assistantId: ASSISTANT_ID,
          threadId: getThread(),
          runId: "", // c√≥ th·ªÉ b·ªï sung ·ªü backend n·∫øu c·∫ßn
          user: msg,
          assistant: document.querySelectorAll('.row.bot .bubble:last-child')[0]?.textContent || ""
        })
      }).catch(()=>{});
    } catch(e){}

  } catch(e){
    thinking.textContent = "‚ö†Ô∏è " + (e && e.message ? e.message : e);
  } finally {
    $btn.disabled=false; $inp.disabled=false; sending=false;
  }
}

// Bind
$btn.onclick = send;
$inp.addEventListener('keydown', (e)=>{
  if (e.isComposing) return; // ƒëang g√µ ti·∫øng Vi·ªát
  if (e.key === "Enter") { e.preventDefault(); send(); }
});
$reset.onclick=()=>{
  document.cookie="edison_email=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/";
  localStorage.removeItem("thread_id");
  sessionStorage.clear();
  location.reload();
};

// Greeting + Suggestions + Privacy
addBubble("bot", "Xin ch√†o! M√¨nh c√≥ th·ªÉ gi√∫p g√¨ cho b·∫°n h√¥m nay li√™n quan ƒë·∫øn CPD kh√¥ng?");
renderSuggestions();

(function ensureEmailOnLoad(){
  if (!getEmail()) {
    const input = prompt("What is your email in Edison Schools?");
    if (input && /@edisonschools\.edu\.vn$/i.test(input)) {
      setEmail(input);
    } else {
      alert("Email must be @edisonschools.edu.vn");
    }
  }
})();
if(!localStorage.getItem("privacyShown")){
  $privacy.style.display="block";
  localStorage.setItem("privacyShown","1");
}
</script>
</body>
</html>
