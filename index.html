<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <title>Edison CPD Chatbot</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    body{font-family:Candara;background:#fff;margin:0;display:flex;flex-direction:column;height:100vh}
    header{padding:10px;background:#f05a23;color:#fff;text-align:center;font-weight:bold}
    #chat{flex:1;overflow:auto;padding:10px;position:relative}
    #chat::before{
      content:"";position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
      background:url('/avatars/logo-edison.png') no-repeat center center;
      background-size:50% auto;opacity:.2;width:100%;height:100%;pointer-events:none
    }
    .row{display:flex;margin:8px 0;animation:fade .25s ease-out}
    @keyframes fade{from{opacity:.2;transform:translateY(4px)}to{opacity:1;transform:none}}
    .row.user{justify-content:flex-end}
    .bubble{padding:10px;border-radius:10px;max-width:70%;white-space:pre-wrap}
    .row.user .bubble{background:#ffe5d5}
    .row.bot .bubble{background:#f1f1f1}
    .avatar{width:32px;height:32px;border-radius:50%;margin:0 6px}
    footer{display:flex;padding:10px;border-top:1px solid #ddd;gap:8px}
    footer input{flex:1;padding:10px;border:1px solid #ccc;border-radius:5px}
    footer button{padding:10px 12px;background:#f05a23;color:#fff;border:none;border-radius:5px;cursor:pointer}
    .privacy{font-size:12px;color:#666;text-align:center;padding:5px;display:none}
    .hint{font-size:13px;padding:8px;color:#444}
    .muted{opacity:.75}
  </style>
</head>
<body>
  <header>Edison CPD Chatbot</header>
  <div id="chat"></div>
  <div class="privacy" id="privacy">Your chat may be saved to a private log for quality and troubleshooting.</div>
  <footer>
    <input id="inp" placeholder="Type your message..."/>
    <button id="btn">Send</button>
    <button id="reset">Start new session</button>
  </footer>

<script>
const ENDPOINT = "/.netlify/functions/assist1";
const LOG_ENDPOINT = "/.netlify/functions/drive-log";
const ASSISTANT_ID = "asst_dI6JMhNkMf1lWs1ndxkj6eGA";

const $chat=document.getElementById('chat');
const $inp=document.getElementById('inp');
const $btn=document.getElementById('btn');
const $reset=document.getElementById('reset');
const $privacy=document.getElementById('privacy');

function addBubble(role,text,extraClass=""){
  const row=document.createElement('div');row.className="row "+role;
  const avatar=document.createElement('img');avatar.className="avatar";avatar.src=role==="user"?"/avatars/user.png":"/avatars/bot.png";
  const bubble=document.createElement('div');bubble.className="bubble "+extraClass;bubble.textContent=text;
  if(role==="user"){row.appendChild(bubble);row.appendChild(avatar);}
  else{row.appendChild(avatar);row.appendChild(bubble);}
  $chat.appendChild(row);$chat.scrollTop=$chat.scrollHeight;
  return bubble;
}

function getEmail(){
  const m=document.cookie.split('; ').find(r=>r.startsWith('edison_email='));
  return m?decodeURIComponent(m.split('=')[1]):null;
}
function setEmail(email){
  document.cookie="edison_email="+encodeURIComponent(email)+"; max-age="+60*60*24*90+"; path=/";
}
function getSession(){
  if(!sessionStorage.session_id) sessionStorage.session_id="s_"+Date.now()+"_"+Math.random().toString(36).slice(2);
  return sessionStorage.session_id;
}
function getThread(){return localStorage.getItem("thread_id")||"";}
function setThread(id){localStorage.setItem("thread_id",id);}

async function callAssist(payload){
  const res = await fetch(ENDPOINT, { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(payload) });
  const text = await res.text();
  let data = {};
  try{ data = text? JSON.parse(text) : {}; }catch{ data = { error: "Bad JSON", raw:text }; }
  return { status: res.status, ok: res.ok, data, text };
}

async function pollUntilDone(threadId, runId, thinkingBubble){
  for (let i=0;i<40;i++){ // ~40s
    const r = await callAssist({ action:"poll", threadId, runId });
    if (r.status === 200 && r.data && r.data.done) {
      return r.data.reply || "No response.";
    }
    if (r.status !== 202) break;
    thinkingBubble.textContent = "ƒêang x·ª≠ l√Ω‚Ä¶";
    await new Promise(res=>setTimeout(res, 1000));
  }
  return "H·ªá th·ªëng ƒëang b·∫≠n. Vui l√≤ng th·ª≠ l·∫°i.";
}

function fmtReply(text){
  return (text || "")
    .split(/\r?\n/)
    .map(s => s.trim())
    .filter(s => s.length > 0)              // b·ªè d√≤ng tr·∫Øng
    .map(l => l.startsWith("üëâ") ? l : "üëâ " + l)  // tr√°nh tr√πng icon
    .join("\n");
}

function cleanAssistant(text){
  if (!text) return "";
  let t = text;

  // C·∫Øt ph·∫ßn References/Resources ·ªü cu·ªëi
  const cutMarks = [
    /^#+\s*references\b/i, /^#+\s*resources\b/i,
    /^#+\s*(t√†i li·ªáu|tham kh·∫£o)\b/i,
    /^\s*(references|resources|t√†i li·ªáu tham kh·∫£o|ngu·ªìn)\s*:\s*$/i
  ];
  const lines = t.split(/\r?\n/);
  const idx = lines.findIndex(line => cutMarks.some(rx => rx.test(line.trim())));
  if (idx !== -1) t = lines.slice(0, idx).join("\n");

  // Lo·∫°i c√°c token ki·ªÉu [8:1source], [source], [8:2source]...
  t = t.replace(/\[[^\]]*source[^\]]*\]/gi, "");

  // Lo·∫°i c√°c d·∫•u tham chi·∫øu s·ªë ƒë∆°n gi·∫£n [1], [2]...
  t = t.replace(/\[\s*\d+\s*\]/g, "");

  // Gom nhi·ªÅu d√≤ng tr·∫Øng th√†nh 1
  t = t.replace(/\n{2,}/g, "\n");

  // B·ªè c√¢u r√†o ƒë√≥n kh√¥ng c·∫ßn thi·∫øt
  t = t.replace(/\b(as an ai|i'm an ai|as a language model)[^.\n]*[.\n]/gi, "");

  return t.trim();
}

async function send(){
  let email=getEmail();
  if(!email){
    const input=prompt("What is your email in Edison Schools?");
    if(!input||!/@edisonschools\.edu\.vn$/i.test(input)){alert("Email must be @edisonschools.edu.vn");return;}
    setEmail(input); email=input;
  }
  const msg=$inp.value.trim(); if(!msg) return; $inp.value=""; $inp.focus();

  addBubble("user", msg);
  const thinking=addBubble("bot","...", "muted");
  $btn.disabled=true;

  try{
    // Nh·ªãp 1: h·ªèi
    const ask = await callAssist({ message: msg, email, session: getSession(), threadId: getThread() });

    // L·ªói server ‚Üí hi·ªÉn th·ªã text th√¥
    if (!ask.ok && ask.status !== 202) {
      thinking.textContent = `‚ö†Ô∏è Server ${ask.status}: ${ask.text || 'No body'}`;
      $btn.disabled=false; return;
    }

    let reply = "";
    let realThreadId = ask.data?.threadId || getThread();
    if (ask.status === 200 && ask.data?.reply) {
      reply = ask.data.reply;
      if (ask.data.threadId) setThread(ask.data.threadId);
    } else {
      // 202 ‚Üí poll
      realThreadId = ask.data?.threadId || realThreadId;
      if (realThreadId) setThread(realThreadId);
      const runId = ask.data?.runId;
      reply = await pollUntilDone(realThreadId, runId, thinking);
    }

    // Hi·ªÉn th·ªã k·∫øt qu·∫£
    thinking.classList.remove("muted");
    thinking.textContent = fmtReply(cleanAssistant(reply);

    // Ghi log (best-effort, kh√¥ng ch·∫∑n UI)
    try {
      await fetch(LOG_ENDPOINT, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({
          session: getSession(),
          assistantId: ASSISTANT_ID,
          threadId: getThread(),
          runId: ask.data?.runId || "",
          user: msg,
          assistant: reply
        })
      });
    } catch(e){ /* im l·∫∑ng */ }

  } catch(e){
    thinking.textContent = "‚ö†Ô∏è " + e.message;
  }
  $btn.disabled=false;
}

$btn.onclick=send;
$inp.onkeydown=e=>{if(e.key==="Enter")send();}
$reset.onclick=()=>{document.cookie="edison_email=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/";localStorage.removeItem("thread_id");sessionStorage.clear();location.reload();}

// C√¢u ch√†o tƒ©nh khi m·ªü trang
addBubble("bot", "Xin ch√†o! M√¨nh c√≥ th·ªÉ gi√∫p g√¨ cho b·∫°n h√¥m nay li√™n quan ƒë·∫øn CPD kh√¥ng?");

// H·ªèi email ngay khi v√†o trang (n·∫øu ch∆∞a c√≥ cookie)
(function ensureEmailOnLoad(){
  if (!getEmail()) {
    const input = prompt("What is your email in Edison Schools?");
    if (input && /@edisonschools\.edu\.vn$/i.test(input)) {
      setEmail(input);
    } else {
      alert("Email must be @edisonschools.edu.vn");
    }
  }
})();

// Privacy line: hi·ªán 1 l·∫ßn
if(!localStorage.getItem("privacyShown")){$privacy.style.display="block";localStorage.setItem("privacyShown","1");}
</script>
</body>
</html>
